<!DOCTYPE html><html lang="en"><head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamAI Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.3/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg: #000000;
            --surface: #0f0f0f;
            --surface-2: #111111;
            --text: #ffffff;
            --muted: #b3b3b3;
            --border: rgba(255, 255, 255, 0.15);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.60);
        }

        body.app-bg {
            min-height: 100vh;
            background: var(--bg);
            color: var(--text);
        }

        .glass {
            background: var(--surface);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .glass-soft {
            background: var(--surface-2);
            border: 1px solid var(--border);
        }

        ::placeholder { color: var(--muted); opacity: 1; }
        button i, a i { color: inherit; }

        .text-muted { color: var(--muted); }
        .text-main { color: var(--text); }
        .border-soft { border-color: var(--border); }
        .border-strong { border-color: var(--border); }
        .avatar-grad {
            background: var(--surface-2);
            border: 1px solid var(--border);
        }
        .btn-mono {
            background: #000000;
            color: #ffffff;
            border: 1px solid var(--border);
            transition: transform 0.12s ease, opacity 0.12s ease;
        }
        .btn-mono:hover {
            background: #ffffff;
            color: #000000;
        }
        .btn-mono:disabled {
            opacity: 0.55;
        }

        .btn-mono-soft {
            background: var(--surface);
            color: #ffffff;
            border: 1px solid var(--border);
            transition: transform 0.12s ease, opacity 0.12s ease;
        }
        .btn-mono-soft:hover {
            background: #ffffff;
            color: #000000;
        }

        .btn-signout {
            background: transparent;
            color: #ffffff;
            border: 1px dashed var(--border);
        }
        .btn-signout:hover {
            background: #ffffff;
            color: #000000;
            border-style: solid;
        }

        .bubble-user {
            background: #000000;
            border: 1px solid var(--border);
            color: #ffffff;
        }
        .bubble-assistant {
            background: var(--surface-2);
            border: 1px dashed var(--border);
            color: #ffffff;
        }

        .ratio-16x9 { aspect-ratio: 16 / 9; }
        .ratio-1x1 { aspect-ratio: 1 / 1; }
        .history-max { max-height: calc(100vh - 290px); }
        @media (min-width: 1024px) {
            .chat-panel-height { height: calc(100vh - 160px); }
        }
        .text-error { color: var(--muted); }
        .code-inline {
            background: rgba(255,255,255,0.10);
            border: 1px solid var(--border);
        }
        .img-card-bg { background: rgba(255,255,255,0.06); }

        .focus-ring:focus {
            outline: none;
            box-shadow: none;
            border-color: rgba(255, 255, 255, 0.9) !important;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.9);
            display: inline-block;
            animation: typing 1.1s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.12s; }
        .typing-dot:nth-child(3) { animation-delay: 0.24s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.45; }
            30% { transform: translateY(-3px); opacity: 1; }
        }

        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
        }

        .chat-message {
            display: block;
            word-wrap: break-word;
            margin-bottom: 2px;
        }
        .spinner {
            display: none;
            border: 4px solid rgba(255, 255, 255, 0.10);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-top-color: rgba(255, 255, 255, 0.90);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
          #chatLog::-webkit-scrollbar {
      width: 8px;
    }
    #chatLog::-webkit-scrollbar-track {
      background-color: #000000;
    }
    #chatLog::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.20);
      border-radius: 999px;
    }
    </style>
</head>
<body class="app-bg">
    <a href="#chatInput" class="sr-only focus:not-sr-only focus-ring fixed top-4 left-4 z-50 px-3 py-2 rounded-lg glass-soft">Skip to message input</a>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 opacity-0 pointer-events-none transition-opacity lg:hidden" aria-hidden="true"></div>

    <div class="min-h-screen w-full">
        <div class="relative lg:flex lg:items-stretch">
            <aside id="sidebar" class="glass fixed lg:static lg:translate-x-0 lg:h-screen left-0 top-0 h-screen w-80 max-w-xs transform -translate-x-full transition-transform z-50 flex flex-col" role="navigation" aria-label="Sidebar">
                <div class="px-4 py-4 flex items-center justify-between border-b border-soft">
                    <div class="min-w-0">
                        <div class="text-base font-semibold truncate">StreamAI</div>
                        <div class="text-xs text-muted">Chat</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="closeSidebarBtn" type="button" class="focus-ring btn-mono-soft inline-flex items-center justify-center w-10 h-10 rounded-xl lg:hidden" aria-label="Close sidebar">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <div class="p-3">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="newChatBtn" type="button" class="focus-ring btn-mono-soft rounded-xl px-3 py-2 text-sm font-semibold">
                            <i class="fas fa-plus mr-2" aria-hidden="true"></i>New
                        </button>
                        <button id="clearHistoryBtn" type="button" class="focus-ring btn-mono-soft rounded-xl px-3 py-2 text-sm font-semibold">
                            <i class="fas fa-trash mr-2" aria-hidden="true"></i>Clear
                        </button>
                    </div>
                </div>

                <div class="px-3 pb-2">
                    <label for="historySearch" class="sr-only">Search history</label>
                    <div class="glass rounded-xl flex items-center px-3 py-2">
                        <i class="fas fa-search text-sm text-muted" aria-hidden="true"></i>
                        <input id="historySearch" class="ml-2 w-full bg-transparent text-sm focus:outline-none text-main" placeholder="Search history" autocomplete="off" />
                    </div>
                </div>

                <div class="px-4 pt-2 pb-2">
                    <h2 class="text-xs font-semibold tracking-widest uppercase text-muted">History</h2>
                </div>
                <div id="historyList" class="px-3 pb-3 space-y-2 overflow-auto history-max"></div>

                <div class="mt-auto p-3">
                    <div class="glass-soft rounded-2xl p-3 flex items-center justify-between gap-3">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-2xl avatar-grad"></div>
                            <div class="min-w-0">
                                <div id="accountName" class="text-sm font-semibold truncate">Guest</div>
                                <div class="text-xs text-muted">Local session</div>
                            </div>
                        </div>
                        <button id="editAccountBtn" type="button" class="focus-ring btn-mono-soft inline-flex items-center justify-center w-10 h-10 rounded-xl" aria-label="Edit account name">
                            <i class="fas fa-user-edit" aria-hidden="true"></i>
                        </button>
                    </div>

                    <div class="mt-3 space-y-2">
                        <div id="googleSignIn" class="w-full"></div>
                        <button id="signOutBtn" type="button" class="focus-ring btn-signout w-full rounded-xl px-3 py-2 text-sm font-semibold hidden">
                            Sign out
                        </button>
                        <p class="text-xs text-muted">
                            Sign-in uses Google Identity Services.
                        </p>
                    </div>
                </div>
            </aside>

            <main class="min-h-screen lg:h-screen lg:overflow-hidden lg:flex-1 lg:ml-0">
                <header class="sticky top-0 z-30">
                    <div class="px-4 sm:px-6 py-4">
                        <div class="glass-soft rounded-2xl px-4 py-3 flex items-center justify-between">
                            <button id="openSidebarBtn" type="button" class="focus-ring btn-mono-soft inline-flex items-center justify-center w-10 h-10 rounded-xl lg:hidden" aria-label="Open sidebar">
                                <i class="fas fa-bars" aria-hidden="true"></i>
                            </button>

                            <div class="min-w-0 text-center flex-1 px-3">
                                <div class="text-sm sm:text-base font-semibold truncate">StreamAI</div>
                                <div id="statusText" class="text-xs text-muted">Ready</div>
                            </div>

                            <div class="w-10 h-10 lg:hidden" aria-hidden="true"></div>
                        </div>
                    </div>
                </header>

                <section class="px-4 sm:px-6 pb-28 lg:pb-6">
                    <div class="glass-soft rounded-2xl p-3 sm:p-4 lg:overflow-hidden flex flex-col chat-panel-height">
                        <div id="chatLog" class="flex-1 overflow-auto space-y-3" role="log" aria-live="polite" aria-relevant="additions" aria-label="Chat messages"></div>

                        <div id="typingRow" class="hidden mt-2">
                            <div class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl glass-soft">
                                <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                                <span class="text-xs text-muted">Assistant is typing</span>
                            </div>
                        </div>
                    </div>
                </section>

                <footer class="fixed bottom-0 left-0 right-0 z-40 lg:pl-80">
                    <div class="px-4 sm:px-6 pb-4">
                        <div class="glass rounded-2xl p-3">
                            <form id="chatForm" class="space-y-2" aria-label="Send a message">
                                <div class="flex items-stretch gap-2">
                                    <label for="chatInput" class="sr-only">Message</label>
                                    <input id="chatInput" type="text" class="focus-ring w-full rounded-xl px-4 py-3 bg-black border border-strong" placeholder="Type your message" autocomplete="off" />

                                    <button id="helpBtn" type="button" class="focus-ring btn-mono-soft inline-flex items-center justify-center w-12 rounded-xl" aria-label="Image help">
                                        <i class="fas fa-image" aria-hidden="true"></i>
                                    </button>

                                    <button id="sendButton" type="submit" class="focus-ring inline-flex items-center justify-center px-5 rounded-xl font-semibold btn-mono">
                                        Send
                                    </button>
                                </div>

                                <div class="flex items-center justify-between">
                                    <p id="errorText" class="text-xs hidden text-error"></p>
                                    <p class="text-xs text-muted">
                                        Tip: use <span class="font-semibold">/image</span> to generate an image.
                                    </p>
                                </div>
                            </form>
                        </div>
                    </div>
                </footer>
            </main>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-label="Image preview">
        <div id="imageModalOverlay" class="absolute inset-0 bg-black bg-opacity-70"></div>
        <div class="relative w-full max-w-4xl">
            <div class="glass rounded-2xl overflow-hidden">
                <div class="flex items-center justify-between px-4 py-3 border-b border-soft">
                    <div class="text-sm font-semibold">Preview</div>
                    <div class="flex items-center gap-2">
                        <a id="imageDownload" class="focus-ring btn-mono-soft inline-flex items-center justify-center px-3 py-2 rounded-xl text-sm font-semibold" download="generated-image.png">
                            <i class="fas fa-download mr-2" aria-hidden="true"></i>Download
                        </a>
                        <button id="imageClose" type="button" class="focus-ring btn-mono-soft inline-flex items-center justify-center w-10 h-10 rounded-xl" aria-label="Close preview">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div class="p-3 sm:p-4">
                    <div class="w-full ratio-16x9">
                        <img id="imageModalImg" alt="Generated" class="w-full h-full object-contain rounded-xl" loading="lazy" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (() => {
            // Google OAuth (GIS) setup
            // IMPORTANT: Replace this with your real Google OAuth Client ID
            // Example: "1234567890-abcdefg.apps.googleusercontent.com"
            const GOOGLE_CLIENT_ID = '470178146094-7f1aash9usp4oodsc15vtl6kf0v2n8d7.apps.googleusercontent.com';

            const API_IMAGE = 'https://backend.buildpicoapps.com/aero/run/image-generation-api?pk=v1-Z0FBQUFBQnBaZElmVTV2a2pTZE56Y2MtYkZDcHlwb3ZzQWJwS0daWi1lMnFpYndSTmlvQW1jQU9RR2x1Q1JfOWQ1WkVXUXNiSFlaaUFOend6VzBjZldTVGM1WUhFek1IQ1E9PQ==';
            const API_LLM = 'https://backend.buildpicoapps.com/aero/run/llm-api?pk=v1-Z0FBQUFBQnBaZElmVTV2a2pTZE56Y2MtYkZDcHlwb3ZzQWJwS0daWi1lMnFpYndSTmlvQW1jQU9RR2x1Q1JfOWQ1WkVXUXNiSFlaaUFOend6VzBjZldTVGM1WUhFek1IQ1E9PQ==';
            const STORAGE = {
                history: 'streamai_history_v2',
                account: 'streamai_account_name_v2',
                theme: 'streamai_theme_v1',
                googleIdToken: 'streamai_google_id_token_v1',
                googleProfile: 'streamai_google_profile_v1'
            };

            const el = {
                overlay: document.getElementById('overlay'),
                sidebar: document.getElementById('sidebar'),
                openSidebarBtn: document.getElementById('openSidebarBtn'),
                closeSidebarBtn: document.getElementById('closeSidebarBtn'),
                newChatBtn: document.getElementById('newChatBtn'),
                clearHistoryBtn: document.getElementById('clearHistoryBtn'),
                historyList: document.getElementById('historyList'),
                historySearch: document.getElementById('historySearch'),
                accountName: document.getElementById('accountName'),
                editAccountBtn: document.getElementById('editAccountBtn'),
                googleSignIn: document.getElementById('googleSignIn'),
                signOutBtn: document.getElementById('signOutBtn'),
                statusText: document.getElementById('statusText'),
                errorText: document.getElementById('errorText'),
                chatForm: document.getElementById('chatForm'),
                chatInput: document.getElementById('chatInput'),
                sendButton: document.getElementById('sendButton'),
                helpBtn: document.getElementById('helpBtn'),
                chatLog: document.getElementById('chatLog'),
                typingRow: document.getElementById('typingRow'),
                imageModal: document.getElementById('imageModal'),
                imageModalOverlay: document.getElementById('imageModalOverlay'),
                imageModalImg: document.getElementById('imageModalImg'),
                imageClose: document.getElementById('imageClose'),
                imageDownload: document.getElementById('imageDownload')
            };

            const state = {
                busy: false,
                messages: [],
                history: [],
                historyQuery: ''
            };

            const utils = {
                now() { return Date.now(); },
                formatTime(ms) {
                    try {
                        return new Date(ms).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    } catch {
                        return '';
                    }
                },
                decodeJwtPayload(jwt) {
                    try {
                        const parts = String(jwt || '').split('.');
                        if (parts.length < 2) return null;
                        const base64Url = parts[1];
                        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const padded = base64 + '==='.slice((base64.length + 3) % 4);
                        const json = decodeURIComponent(atob(padded).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                        return JSON.parse(json);
                    } catch {
                        return null;
                    }
                },
                safeJsonParse(raw, fallback) {
                    try { return JSON.parse(raw); } catch { return fallback; }
                },
                debounce(fn, wait = 160) {
                    let t;
                    return (...args) => {
                        clearTimeout(t);
                        t = setTimeout(() => fn(...args), wait);
                    };
                },
                escapeHtml(str) {
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }
            };

            const markdown = {
                render(text) {
                    const escaped = utils.escapeHtml(text);
                    let out = escaped;
                    out = out.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                    out = out.replace(/\*(.+?)\*/g, '<em>$1</em>');
                    out = out.replace(/`([^`]+?)`/g, '<code class="px-1 py-0.5 rounded code-inline">$1</code>');
                    out = out.replace(/\[([^\]]+?)\]\((https?:\/\/[^\s)]+)\)/g, '<a class="underline" href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
                    out = out.replace(/\n/g, '<br />');
                    return out;
                }
            };

            const storage = {
                get(key, fallback) {
                    return utils.safeJsonParse(localStorage.getItem(key) || '', fallback);
                },
                set(key, value) {
                    try { localStorage.setItem(key, JSON.stringify(value)); } catch { }
                },
                getRaw(key) {
                    try { return localStorage.getItem(key); } catch { return null; }
                },
                setRaw(key, value) {
                    try { localStorage.setItem(key, value); } catch { }
                }
            };

            const a11y = {
                setError(msg) {
                    if (!msg) {
                        el.errorText.classList.add('hidden');
                        el.errorText.textContent = '';
                        el.errorText.removeAttribute('role');
                        return;
                    }
                    el.errorText.textContent = msg;
                    el.errorText.classList.remove('hidden');
                    el.errorText.setAttribute('role', 'alert');
                },
                setStatus(msg) {
                    el.statusText.textContent = msg;
                }
            };

            const sidebar = {
                isMobile() {
                    return window.matchMedia('(max-width: 1023px)').matches;
                },
                open() {
                    if (!sidebar.isMobile()) return;
                    el.sidebar.classList.remove('-translate-x-full');
                    el.sidebar.classList.add('translate-x-0');
                    el.overlay.classList.remove('opacity-0', 'pointer-events-none');
                    el.overlay.classList.add('opacity-100');
                    el.overlay.setAttribute('aria-hidden', 'false');
                    el.closeSidebarBtn.focus();
                },
                close({ focusOpenBtn = true } = {}) {
                    if (!sidebar.isMobile()) return;
                    el.sidebar.classList.add('-translate-x-full');
                    el.sidebar.classList.remove('translate-x-0');
                    el.overlay.classList.add('opacity-0', 'pointer-events-none');
                    el.overlay.classList.remove('opacity-100');
                    el.overlay.setAttribute('aria-hidden', 'true');
                    if (focusOpenBtn) el.openSidebarBtn.focus();
                }
            };

            const api = {
                async post(url, prompt) {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    if (!res.ok) throw new Error('Network error');
                    return res.json();
                },
                withPersona(prompt) {
                    return "Follow instructions precisely! If the user asks to generate, create or make an image, photo, or picture by describing it, You will reply with '/image' + description. Otherwise, You will respond normally. Avoid additional explanations." + prompt;
                }
            };

            const chat = {
                setBusy(isBusy) {
                    state.busy = isBusy;
                    el.sendButton.disabled = isBusy;
                    el.chatInput.disabled = isBusy;
                    el.helpBtn.disabled = isBusy;
                    el.sendButton.classList.toggle('opacity-70', isBusy);
                    if (isBusy) {
                        a11y.setStatus('Thinking…');
                        el.typingRow.classList.remove('hidden');
                    } else {
                        a11y.setStatus('Ready');
                        el.typingRow.classList.add('hidden');
                    }
                },
                scrollToBottom() {
                    requestAnimationFrame(() => {
                        el.chatLog.scrollTop = el.chatLog.scrollHeight;
                    });
                },
                addMessage({ role, type = 'text', content, imageUrl, at = utils.now() }) {
                    const msg = { id: String(utils.now()) + Math.random().toString(16).slice(2), role, type, content, imageUrl, at };
                    state.messages.push(msg);
                    ui.appendMessage(msg);
                    chat.scrollToBottom();
                }
            };

            const history = {
                load() {
                    const items = storage.get(STORAGE.history, []);
                    state.history = Array.isArray(items) ? items : [];
                },
                save() {
                    storage.set(STORAGE.history, state.history);
                },
                addPrompt(text) {
                    const trimmed = (text || '').trim();
                    if (!trimmed) return;
                    const entry = { id: String(utils.now()), text: trimmed.slice(0, 160), at: utils.now() };
                    state.history = [entry, ...state.history].slice(0, 50);
                    history.save();
                    history.render();
                },
                clear() {
                    state.history = [];
                    history.save();
                    history.render();
                },
                filtered() {
                    const q = (state.historyQuery || '').toLowerCase();
                    if (!q) return state.history;
                    return state.history.filter(h => (h.text || '').toLowerCase().includes(q));
                },
                render() {
                    const items = history.filtered();
                    el.historyList.innerHTML = '';
                    if (items.length === 0) {
                        const empty = document.createElement('div');
                        empty.className = 'glass-soft rounded-2xl p-3 text-sm';
                        empty.classList.add('text-muted');
                        empty.textContent = state.historyQuery ? 'No matches.' : 'No history yet.';
                        el.historyList.appendChild(empty);
                        return;
                    }

                    const frag = document.createDocumentFragment();
                    items.forEach((item, idx) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'focus-ring w-full text-left glass-soft rounded-2xl p-3 hover:opacity-95 transition';
                        btn.setAttribute('data-history-id', item.id);
                        btn.setAttribute('role', 'button');
                        btn.innerHTML = `
                            <div class="text-sm font-semibold text-main"></div>
                            <div class="text-xs mt-1 text-muted"></div>
                        `;
                        btn.querySelector('div').textContent = item.text;
                        btn.querySelectorAll('div')[1].textContent = new Date(item.at).toLocaleString();
                        btn.addEventListener('click', () => {
                            el.chatInput.value = item.text;
                            el.chatInput.focus();
                            sidebar.close({ focusOpenBtn: false });
                        });
                        btn.addEventListener('keydown', (e) => {
                            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                                e.preventDefault();
                                const all = Array.from(el.historyList.querySelectorAll('button[data-history-id]'));
                                const next = e.key === 'ArrowDown' ? Math.min(idx + 1, all.length - 1) : Math.max(idx - 1, 0);
                                all[next]?.focus();
                            }
                        });
                        frag.appendChild(btn);
                    });
                    el.historyList.appendChild(frag);
                }
            };

            const ui = {
                appendMessage(msg) {
                    const wrap = document.createElement('div');
                    const isUser = msg.role === 'user';
                    wrap.className = isUser ? 'flex justify-end' : 'flex justify-start';

                    const bubble = document.createElement('div');
                    bubble.className = (isUser
                        ? 'max-w-full sm:max-w-xl lg:max-w-2xl rounded-2xl p-3 bubble-user'
                        : 'max-w-full sm:max-w-xl lg:max-w-2xl rounded-2xl p-3 bubble-assistant');

                    const meta = document.createElement('div');
                    meta.className = 'flex items-center justify-between gap-3 mb-2';
                    meta.innerHTML = `
                        <div class="text-xs text-muted"></div>
                        <button type="button" class="focus-ring inline-flex items-center justify-center w-9 h-9 rounded-xl glass-soft" aria-label="Copy message">
                            <i class="far fa-copy" aria-hidden="true"></i>
                        </button>
                    `;
                    meta.querySelector('div').textContent = (isUser ? 'You' : 'Assistant') + ' · ' + utils.formatTime(msg.at);
                    meta.querySelector('button').addEventListener('click', async () => {
                        try {
                            const txt = msg.type === 'image' ? (msg.imageUrl || '') : (msg.content || '');
                            await navigator.clipboard.writeText(txt);
                            a11y.setStatus('Copied');
                            setTimeout(() => a11y.setStatus(state.busy ? 'Thinking…' : 'Ready'), 600);
                        } catch {
                            a11y.setError('Copy failed.');
                            setTimeout(() => a11y.setError(''), 1200);
                        }
                    });

                    const content = document.createElement('div');
                    content.className = 'text-sm leading-relaxed';

                    if (msg.type === 'image') {
                        const card = document.createElement('button');
                        card.type = 'button';
                        card.className = 'focus-ring w-full rounded-2xl overflow-hidden border';
                        card.classList.add('border-soft');
                        card.innerHTML = `
                            <div class="w-full ratio-1x1 img-card-bg">
                                <img alt="Generated image" class="w-full h-full object-cover" loading="lazy" />
                            </div>
                        `;
                        const img = card.querySelector('img');
                        img.src = msg.imageUrl;
                        card.addEventListener('click', () => modal.open(msg.imageUrl));
                        content.appendChild(card);
                    } else {
                        content.innerHTML = markdown.render(msg.content || '');
                    }

                    bubble.appendChild(meta);
                    bubble.appendChild(content);
                    wrap.appendChild(bubble);
                    el.chatLog.appendChild(wrap);
                },
                clearChat() {
                    state.messages = [];
                    el.chatLog.innerHTML = '';
                    a11y.setError('');
                    a11y.setStatus('Ready');
                }
            };

            const modal = {
                open(url) {
                    el.imageModalImg.src = url;
                    el.imageDownload.href = url;
                    el.imageModal.classList.remove('hidden');
                    el.imageModal.classList.add('flex');
                    el.imageClose.focus();
                },
                close() {
                    el.imageModal.classList.add('hidden');
                    el.imageModal.classList.remove('flex');
                    el.imageModalImg.src = '';
                }
            };

            const account = {
                load() {
                    const name = storage.getRaw(STORAGE.account);
                    if (name && name.trim()) el.accountName.textContent = name.trim();

                    // Restore Google profile if present
                    const profile = storage.get(STORAGE.googleProfile, null);
                    if (profile && profile.name) {
                        el.accountName.textContent = profile.name;
                        el.signOutBtn.classList.remove('hidden');
                        if (el.googleSignIn) el.googleSignIn.classList.add('hidden');
                    }
                },
                edit() {
                    const current = el.accountName.textContent || 'Guest';
                    const next = prompt('Enter display name', current);
                    if (next === null) return;
                    const cleaned = (next || '').trim().slice(0, 40) || 'Guest';
                    el.accountName.textContent = cleaned;
                    storage.setRaw(STORAGE.account, cleaned);
                }
            };

            const googleAuth = {
                isConfigured() {
                    return GOOGLE_CLIENT_ID && GOOGLE_CLIENT_ID !== 'PASTE_YOUR_GOOGLE_CLIENT_ID_HERE';
                },
                renderButton() {
                    if (!el.googleSignIn) return;
                    el.googleSignIn.innerHTML = '';

                    if (!googleAuth.isConfigured()) {
                        const warn = document.createElement('div');
                        warn.className = 'text-xs text-muted';
                        warn.textContent = 'Set GOOGLE_CLIENT_ID in index.html to enable Google sign-in.';
                        el.googleSignIn.appendChild(warn);
                        return;
                    }

                    if (!window.google || !window.google.accounts || !window.google.accounts.id) {
                        const warn = document.createElement('div');
                        warn.className = 'text-xs text-muted';
                        warn.textContent = 'Google sign-in script not loaded yet.';
                        el.googleSignIn.appendChild(warn);
                        return;
                    }

                    window.google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: googleAuth.onCredential
                    });

                    // NOTE: Google button includes Google branding (logo) by policy.
                    window.google.accounts.id.renderButton(el.googleSignIn, {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        shape: 'pill',
                        width: 260
                    });
                },
                onCredential(response) {
                    const token = response && response.credential;
                    if (!token) {
                        a11y.setError('Google sign-in failed.');
                        return;
                    }

                    const payload = utils.decodeJwtPayload(token);
                    const profile = payload ? {
                        name: payload.name || payload.email || 'Google User',
                        email: payload.email || '',
                        picture: payload.picture || ''
                    } : { name: 'Google User', email: '', picture: '' };

                    storage.setRaw(STORAGE.googleIdToken, token);
                    storage.set(STORAGE.googleProfile, profile);

                    el.accountName.textContent = profile.name;
                    el.signOutBtn.classList.remove('hidden');
                    if (el.googleSignIn) el.googleSignIn.classList.add('hidden');
                    a11y.setStatus('Signed in');
                    setTimeout(() => a11y.setStatus(state.busy ? 'Thinking…' : 'Ready'), 900);
                },
                signOut() {
                    storage.setRaw(STORAGE.googleIdToken, '');
                    storage.set(STORAGE.googleProfile, null);
                    try {
                        if (window.google && window.google.accounts && window.google.accounts.id) {
                            window.google.accounts.id.disableAutoSelect();
                        }
                    } catch {
                    }
                    el.accountName.textContent = storage.getRaw(STORAGE.account) || 'Guest';
                    el.signOutBtn.classList.add('hidden');
                    if (el.googleSignIn) el.googleSignIn.classList.remove('hidden');
                    googleAuth.renderButton();
                    a11y.setStatus('Signed out');
                    setTimeout(() => a11y.setStatus(state.busy ? 'Thinking…' : 'Ready'), 900);
                }
            };

            const help = {
                show() {
                    a11y.setError('');
                    a11y.setStatus('Tip: type /image then a description.');
                    setTimeout(() => a11y.setStatus(state.busy ? 'Thinking…' : 'Ready'), 1500);
                    el.chatInput.focus();
                }
            };

            const controller = {
                async send(text) {
                    const message = (text || '').trim();
                    if (!message || state.busy) return;
                    a11y.setError('');

                    chat.addMessage({ role: 'user', type: 'text', content: message });
                    history.addPrompt(message);
                    el.chatInput.value = '';

                    const isImagePrompt = message.toLowerCase().startsWith('/image');
                    const prompt = isImagePrompt ? message.substring(6).trim() : message;
                    const url = isImagePrompt ? API_IMAGE : API_LLM;

                    try {
                        chat.setBusy(true);
                        const apiPrompt = url === API_LLM ? api.withPersona(prompt) : prompt;
                        const data = await api.post(url, apiPrompt);
                        if (!data || data.status !== 'success') throw new Error('API error');

                        if (url === API_IMAGE) {
                            chat.addMessage({ role: 'assistant', type: 'image', imageUrl: data.imageUrl, content: '' });
                            return;
                        }

                        const textOut = (data.text || '').trim();
                        if (textOut.toLowerCase().startsWith('/image')) {
                            const desc = textOut.substring(textOut.toLowerCase().indexOf('/image') + 6).trim();
                            const imageData = await api.post(API_IMAGE, desc);
                            if (!imageData || imageData.status !== 'success') throw new Error('Image API error');
                            chat.addMessage({ role: 'assistant', type: 'image', imageUrl: imageData.imageUrl, content: '' });
                        } else {
                            chat.addMessage({ role: 'assistant', type: 'text', content: textOut });
                        }
                    } catch (err) {
                        console.error(err);
                        a11y.setError('Something went wrong. Please try again.');
                        chat.addMessage({ role: 'assistant', type: 'text', content: 'An error occurred. Please try again.' });
                    } finally {
                        chat.setBusy(false);
                        el.chatInput.focus();
                    }
                }
            };

            const init = () => {
                account.load();
                history.load();
                history.render();
                a11y.setStatus('Ready');
                el.chatInput.focus();

                // Initialize Google auth UI after load
                window.addEventListener('load', () => {
                    googleAuth.renderButton();
                });

                el.openSidebarBtn.addEventListener('click', () => sidebar.open());
                el.closeSidebarBtn.addEventListener('click', () => sidebar.close());
                el.overlay.addEventListener('click', () => sidebar.close());

                el.newChatBtn.addEventListener('click', () => {
                    ui.clearChat();
                    sidebar.close({ focusOpenBtn: false });
                    el.chatInput.focus();
                });

                el.clearHistoryBtn.addEventListener('click', () => history.clear());
                el.editAccountBtn.addEventListener('click', () => account.edit());
                el.helpBtn.addEventListener('click', () => help.show());

                el.signOutBtn.addEventListener('click', () => googleAuth.signOut());

                el.historySearch.addEventListener('input', utils.debounce((e) => {
                    state.historyQuery = e.target.value || '';
                    history.render();
                }, 120));

                el.chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    controller.send(el.chatInput.value);
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (!el.imageModal.classList.contains('hidden')) {
                            modal.close();
                            el.chatInput.focus();
                            return;
                        }
                        sidebar.close();
                        a11y.setError('');
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        el.historySearch.focus();
                        sidebar.open();
                    }
                });

                el.imageClose.addEventListener('click', () => modal.close());
                el.imageModalOverlay.addEventListener('click', () => modal.close());

                window.addEventListener('resize', utils.debounce(() => {
                    if (!sidebar.isMobile()) {
                        el.overlay.classList.add('opacity-0', 'pointer-events-none');
                        el.overlay.classList.remove('opacity-100');
                        el.overlay.setAttribute('aria-hidden', 'true');
                        el.sidebar.classList.remove('translate-x-0');
                        el.sidebar.classList.remove('-translate-x-full');
                        el.sidebar.classList.add('lg:translate-x-0');
                    } else {
                        el.sidebar.classList.add('-translate-x-full');
                    }
                }, 120));
            };

            init();
        })();
    </script>
</body></html>
